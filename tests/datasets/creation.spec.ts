import { test, expect, type Page } from '@playwright/test'
import * as path from 'path'

const __dirname = import.meta.dirname

const clickOutside = async (page: Page) => {
  // When clicking "Suivant" we execute the validation of the frequency input
  // because we blur outside the select. This validation create a warning (because
  // "Inconnu" is not recommanded), and the warning make the "Suivant" button
  // move a little bit down so the click is miss. We want to fix this one day!
  // (it also happens in a regular browser with a human, so it's really not ideal)
  await page.mouse.click(1, 1)
}

test('can create a minimal dataset', async ({ page }) => {
  await page.goto('/')
  await page.getByRole('button', { name: 'Publier sur data.gouv.fr' }).click()
  await page.getByRole('link', { name: 'Un jeu de données' }).click()
  await page.getByRole('button', { name: 'Commencer la publication' }).click()
  await page.getByTestId('producer-select').click()
  await page.getByRole('option', { name: 'Admin User' }).click()
  await page.getByRole('textbox', { name: 'Titre *' }).click()
  await page.getByRole('textbox', { name: 'Titre *' }).fill('Test jeu de données')
  await page.getByRole('textbox', { name: 'Titre *' }).press('Tab')
  await page.getByTestId('markdown-editor').click()
  await page.getByTestId('markdown-editor').fill('Une description')
  await page.getByTestId('markdown-editor').press('Tab')
  await page.getByText('Il est recommandé d\'avoir une').click()
  await page.getByTestId('select-frequency').click()
  await page.getByRole('option', { name: 'Inconnu' }).click()
  await clickOutside(page)
  await page.getByRole('button', { name: 'Suivant' }).click()
  await page.getByRole('button', { name: 'Ajoutez des fichiers' }).click()
  // Start waiting for file chooser before clicking. Note no await.
  const fileChooserPromise = page.waitForEvent('filechooser')
  await page.getByRole('button', { name: 'Parcourir' }).click()
  const fileChooser = await fileChooserPromise
  await fileChooser.setFiles(path.join(__dirname, '../../public/illustrations/administration.svg'))
  await page.getByRole('button', { name: 'Envoyer' }).click()
  await page.getByRole('button', { name: 'Suivant' }).click()
  await page.getByRole('button', { name: 'Publier le jeu de données' }).click()
  await expect(page.locator('h1')).toContainText('Test jeu de données')
  await expect(page.locator('[id="__nuxt"]')).toContainText('Une description')
  await expect(page.locator('[id="__nuxt"]')).toContainText('Description des données non renseignée')
  await expect(page.locator('[id="__nuxt"]')).toContainText('Ce jeu de données a été publié à l\'initiative et sous la responsabilité de Admin User.')
})

test('can create a dataset with full information', async ({ page }) => {
  await page.goto('/')
  await page.getByRole('button', { name: 'Publier sur data.gouv.fr' }).click()
  await page.getByRole('link', { name: 'Un jeu de données' }).click()
  await page.getByRole('button', { name: 'Commencer la publication' }).click()
  await page.getByTestId('searchable-select-vrifiezlidentitaveclaquellevoussouhaitezpublier').click()
  await page.getByRole('option', { name: 'Admin User' }).click()
  await page.getByRole('textbox', { name: 'Titre *' }).click()
  await page.getByRole('textbox', { name: 'Titre *' }).fill('Mon super jeu de données')
  await page.getByRole('textbox', { name: 'Acronyme' }).click()
  await page.getByRole('textbox', { name: 'Acronyme' }).fill('MSJD')
  await page.getByTestId('markdown-editor').fill(`Contrary to popular belief, Lorem Ipsum is not simply random text. It has roots in a piece of classical Latin literature from 45 BC, making it over 2000 years old. Richard McClintock, a Latin professor at Hampden-Sydney College in Virginia, looked up one of the more obscure Latin words, consectetur, from a Lorem Ipsum passage, and going through the cites of the word in classical literature, discovered the undoubtable source. Lorem Ipsum comes from sections 1.10.32 and 1.10.33 of "de Finibus Bonorum et Malorum" (The Extremes of Good and Evil) by Cicero, written in 45 BC. This book is a treatise on the theory of ethics, very popular during the Renaissance. The first line of Lorem Ipsum, "Lorem ipsum dolor sit amet..", comes from a line in section 1.10.32.

The standard chunk of Lorem Ipsum used since the 1500s is reproduced below for those interested. Sections 1.10.32 and 1.10.33 from "de Finibus Bonorum et Malorum" by Cicero are also reproduced in their exact original form, accompanied by English versions from the 1914 translation by H. Rackham.`)
  await page.getByTestId('searchable-select-motscls').click()
  await page.getByPlaceholder('Chercher un mot clé…').fill('test')
  await page.getByRole('option', { name: 'test' }).click()
  await page.getByPlaceholder('Chercher un mot clé…').fill('toto')
  await page.getByRole('option', { name: 'toto' }).click()
  await clickOutside(page)
  await page.getByTestId('searchable-select-licence').click()
  await page.getByText('Other (Public Domain)').click()
  await clickOutside(page)
  await page.getByTestId('searchable-select-frquencedemisejour').click()
  await page.getByRole('option', { name: 'Ponctuelle' }).click()
  await page.getByRole('textbox', { name: 'début' }).fill('1994-04-14')
  await page.getByRole('textbox', { name: 'fin' }).fill('2025-10-01')
  await page.getByTestId('searchable-select-couverturespatiale').click()
  await page.getByPlaceholder('Rechercher une couverture').fill('france')
  await page.getByText('France Insee : fr').click()
  await page.getByTestId('searchable-select-granularitspatiale').click()
  await page.getByRole('option', { name: 'Pays', exact: true }).click()
  await page.getByRole('button', { name: 'Suivant' }).click()
  await page.getByRole('button', { name: 'Ajoutez des fichiers' }).click()
  await page.getByRole('textbox', { name: 'Lien exact vers le fichier' }).click()
  await page.getByRole('textbox', { name: 'Lien exact vers le fichier' }).fill('https://www.google.fr')
  await page.getByRole('button', { name: 'Envoyer' }).click()
  await page.getByRole('group', { name: 'Fichiers' }).getByRole('button').first().click()
  await page.getByRole('textbox', { name: 'Titre *' }).click()
  await page.getByRole('textbox', { name: 'Titre *' }).fill('Google')
  await page.getByLabel('Type *').selectOption('documentation')
  await page.getByTestId('markdown-editor').click()
  await page.getByTestId('markdown-editor').fill('C\'est Google!')
  await clickOutside(page)
  await page.getByTestId('searchable-select-format').click()
  await page.getByRole('option', { name: 'pdf' }).click()
  await clickOutside(page)
  await page.getByTestId('searchable-select-typemime').click()
  await page.getByRole('option', { name: 'application/pdf' }).click()
  await page.getByTestId('searchable-select-schma').click()
  await page.getByPlaceholder('Rechercher un schéma référenc').fill('irve')
  await page.getByRole('option', { name: 'etalab/schema-irve-statique' }).click()
  await page.getByRole('button', { name: 'Valider' }).click()
  await expect(page.getByLabel('Fichiers')).toContainText('Il est recommandé d\'avoir une description d\'au moins 200 caractères.')
  await page.getByRole('button', { name: 'Suivant' }).click()
  await page.getByRole('button', { name: 'Publier le jeu de données' }).click()
  await expect(page.locator('h1')).toContainText('Mon super jeu de données')
  await expect(page.locator('h1')).toContainText('MSJD')
  await expect(page.locator('dl')).toContainText('Other (Public Domain)')
  await expect(page.locator('dl')).toContainText('Formats de fichiers non standards')
  await page.getByTestId('expand-button').click()
  await expect(page.getByLabel('Aperçu').locator('span')).toContainText('L\'aperçu n\'est pas disponible car la taille du fichier est inconnue. Pour consulter le fichier complet, téléchargez-le en cliquant sur le bouton bleu ou depuis l\'onglet Téléchargements.')
})
